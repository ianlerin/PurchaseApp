@page "/worker"
@using WorkerRecord
@inject NavigationManager NavigationManager

<h3>Worker Info</h3>

<div class="mb-3 row">
    <div class="col-sm-2">
        <input type="text" class="form-control" placeholder="Filter by worker name"
               @bind="FilterName" />
    </div>

    <div class="col-sm-2">
        <select class="form-select" @bind="FilterStatus">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="All">All</option>
        </select>
    </div>
    <div class="col-sm-2">
        <select class="form-select" @bind="FilterNationality">
            <option value="Local">Local</option>
            <option value="Foreign">Foreign</option>
            <option value="All">All</option>
        </select>
    </div>

</div>

@if (Workers == null || !Workers.Any())
{
    <p>No workers found.</p>
}
else
{
    <div class="table-container">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Passport</th>
                    <th>Active</th>
                    <th>EPF</th>
                    <th>Socso</th>
                    <th>Nationality</th>
                    <th>Monthly Rate</th>
                    <th>Hourly Rate</th>
                    <th>Daily Rate</th>
                    <th>OT Rate</th>
                    <th>Sunday Rate</th>
                   
                    
                </tr>
            </thead>
            <tbody>
                @foreach (var worker in Workers.Where(w =>
                            (string.IsNullOrWhiteSpace(FilterName) || w.Name.Contains(FilterName, StringComparison.OrdinalIgnoreCase)) &&
                            (FilterStatus == "All" || string.IsNullOrWhiteSpace(FilterStatus) || w.WorkerStatus.ToString() == FilterStatus) &&
                            (FilterNationality == "All" || string.IsNullOrWhiteSpace(FilterNationality) || w.NationalityStatus.ToString() == FilterNationality)))
                
                {
                    <tr>
                        <td>@worker.ID</td>
                        <td><input type="text" class="form-control" @bind="worker.Name" /></td>
                        <td><input type="text" class="form-control" @bind="worker.Age" /></td>
                        <td><input type="text" class="form-control" @bind="worker.Passport" /></td>
                        <td>
                            <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="worker.WorkerStatus"
                                                                                         TEnum="EWorkerStatus" />
                        </td>
                        <td>
                            <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="worker.EPFStatus"
                                                                                         TEnum="EEPFCategory" />
                        </td>
                        <td>
                            <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="worker.SocsoCategory"
                                                                                         TEnum="ESocsoCategory" />
                        </td>
                        <td>
                            <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="worker.NationalityStatus"
                                                                                         TEnum="ENationalityStatus" />
                        </td>
                        <td><input type="number" class="form-control" step="0.01" @bind="worker.MonthlyRate" /></td>
                        <td><input type="number" class="form-control" step="0.01" @bind="worker.HourlyRate" /></td>
                        <td><input type="number" class="form-control" step="0.01" @bind="worker.DailyRate" readonly /></td>
                        <td><input type="number" class="form-control" step="0.01" @bind="worker.OTRate" readonly /></td>
                        <td><input type="number" class="form-control" step="0.01" @bind="worker.SundayRate" readonly /></td>
             
                        
                    </tr>
                }
            </tbody>
        </table>
        <button class="btn btn-primary" @onclick="SubmitWorker">Submit Worker 
             
        </button>
        <button  class ="btn btn-success" @onclick ="DownloadPdf" >
            Download PDF
        </button>
    </div>
}

@code {
    List<WorkerRecord> Workers = new List<WorkerRecord>();
    string FilterName = "";
    string FilterStatus = "All";
    string FilterNationality = "All";


    [Inject]
    private HttpClient Http { get; set; } 
    [Inject]
    private IJSRuntime JS { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkers();
    }

    private async Task LoadWorkers()
    {
        try
        {
            Workers = await Http.GetFromJsonAsync<List<WorkerRecord>>("api/HR/GetAllWorkers");

        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Failed to load workers: {ex.Message}");
            Workers = new List<WorkerRecord>();
        }
    }

    private async Task SubmitWorker()
    {
        try
        {
            foreach (var worker in Workers)
            {
                var response = await Http.PostAsJsonAsync("api/HR/SubmitWorker", worker);

                if (!response.IsSuccessStatusCode)
                {
                    var errorMessage = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"SubmitFail! Reason: {errorMessage}");
                
                }
            }

            await JS.InvokeVoidAsync("alert", "SubmitSuccess!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"SubmitFail! Exception: {ex.Message}");
        }
    }
    private async Task DownloadPdf()
    {
        if (Workers == null || Workers.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "Table is empty");
            return;
        }

        var status = string.IsNullOrWhiteSpace(FilterStatus) ? "All" : FilterStatus;        
        var nationality = string.IsNullOrWhiteSpace(FilterNationality) ? "All" : FilterNationality;
        var pdfBytes = await Http.GetByteArrayAsync(
            $"api/pdf/hr/workers?status={status}&nationality={nationality}"
        );

        var base64 = Convert.ToBase64String(pdfBytes);

        await JS.InvokeVoidAsync(
            "downloadFileFromBase64",
            $"Workers{status}{nationality}.pdf",
            base64
        );
    }

}



