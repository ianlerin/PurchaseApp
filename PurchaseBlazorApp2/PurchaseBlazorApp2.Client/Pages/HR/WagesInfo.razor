@page "/page-info"
@using PurchaseBlazorApp2.Components.Data
@using WorkerRecord
@using Radzen.Blazor
@inject NavigationManager NavigationManager

<h3>Wage Entry</h3>

<div class="mb-3 row">
    <label class="col-sm-2 col-form-label">Year:</label>
    <div class="col-sm-2">
        <input type="number" class="form-control" @bind="MyWageInfo.Year" />
    </div>

    <label class="col-sm-2 col-form-label">Month:</label>
    <div class="col-sm-2">
        <input type="number" class="form-control" @bind="MyWageInfo.Month" />
    </div>

    <div class="col-sm-2">
        <input type="text" class="form-control" placeholder="Filter by worker name"
               @bind="FilterName"  />
    </div>

    <div class="col-sm-2">
        <button type="button" @onclick="SearchWageInfo" class="btn btn-primary">
            Search
        </button>
    </div>
</div>

@if (MyWageInfo?.WageRecords == null || !MyWageInfo.WageRecords.Any())
{
    <p>No workers found.</p>
}
else
{  
  <div style="overflow-x:auto;">
    <RadzenDataGrid Data="@FilteredWageRecords" 
        TItem="SingleWageRecord" 
        AllowSorting="true"
        Style="min-width:4000px"
        Class="shadow-sm border rounded p-3">
        <Columns>
            <RadzenDataGridColumn TItem="SingleWageRecord" Property="Name" Title="Worker Name" Width="160px">
                <Template Context="record">
                    <RadzenTextBox @bind-Value="record.Name" Style="width:100%" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SingleWageRecord" Property="EPFCategory" Title="EPF Status" Width="140px">
                <Template Context="record">
                    <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="record.EPFCategory" TEnum="EEPFCategory" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SingleWageRecord" Property="SocsoCategory" Title="Socso Status" Width="140px">
                <Template Context="record">
                    <PurchaseBlazorApp2.Client.Components.Helper.EnumDropDownBox @bind-Value="record.SocsoCategory" TEnum="ESocsoCategory" />
                </Template>
            </RadzenDataGridColumn>

                <!-- Daily -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="DailyHours" Title="Daily Hours" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.DailyHours" Style="width:100%; background:#D9EAF7;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="DailyRate" Title="Daily Rate" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.DailyRate" ReadOnly="true" Style="width:100%; background:#D9EAF7;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Daily_wages" Title="Daily Wages" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.Daily_wages" ReadOnly="true" Style="width:100%; background:#D9EAF7;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>

                <!-- OT -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="OTHours" Title="OT Hours" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.OTHours"  Style="width:100%; background:#FFE5E5;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="OTRate" Title="OT Rate" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.OTRate" ReadOnly="true" Style="width:100%; background:#FFE5E5;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="OT_wages" Title="OT Wages" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.OT_wages" ReadOnly="true" Style="width:100%; background:#FFE5E5;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <!-- Sunday -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="SundayHours" Title="Sunday Hours" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.SundayHours" Style="width:100%; background:#FFFFE0;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="SingleWageRecord" Property="SundayRate" Title="Sunday Rate" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.SundayRate" ReadOnly="true" Style="width:100%; background:#FFFFE0;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Sunday_wages" Title="Sunday Wages" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.Sunday_wages" ReadOnly="true" Style="width:100%; background:#FFFFE0;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>

                <!-- Monthly -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="MonthlyHours" Title="Monthly Hours" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.MonthlyHours" Style="width:100%; background:#E0F7E9;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="MonthlyRate" Title="Monthly Rate" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.MonthlyRate" ReadOnly="true" Style="width:100%; background:#E0F7E9;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Monthly_wages" Title="Monthly Wages" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.Monthly_wages" ReadOnly="true" Style="width:100%; background:#E0F7E9" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <!-- Hourly -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="HourlyHours" Title="Hourly Hours" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.HourlyHours" Style="width:100%; background:#E6E6FA" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="HourlyRate" Title="Hourly Rate" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.HourlyRate" ReadOnly="true" Style="width:100%; background:#E6E6FA;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Hourly_wages" Title="Hourly Wages" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" Value="record.Hourly_wages" ReadOnly="true" Style="width:100%; background:#E6E6FA;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>

                <!-- Totals -->
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Gross_wages" Title="Gross Wages" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="EPF_Employer" Title="Employer EPF" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="EPF_Employee" Title="Employee EPF" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Socso_Employer" Title="Employer Socso" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Socso_Employee" Title="Employee Socso" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Deduction" Title="Deduction" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric TValue="decimal" @bind-Value="record.Deduction" Style="width:100% ; background:#FFF3E0;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Deduction_Reason" Title="Deduction Reason" Width="140px">
                    <Template Context="record">
                        <RadzenTextBox @bind-Value="record.Deduction_Reason" Style="width:100% ; background:#FFF3E0;" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Allowance" Title="Allowance" Width="140px">
                    <Template Context="record">
                        <RadzenNumeric  TValue="decimal" Value="record.Allowance" Style="width:100% ; background:#FFF3E0;" Step="0.01" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="SingleWageRecord" Property="Total_wages" Title="Total Wages" Width="140px" />
                <RadzenDataGridColumn TItem="SingleWageRecord" Title="Slip PDF" Width="140px">
                    <Template Context="record">
                        <button class="btn btn-secondary btn-sm"
                                @onclick="() => SlipPdf(record)"
                                @onclick:stopPropagation="true">
                            Download Slip
                        </button>
                    </Template>
                </RadzenDataGridColumn>

        </Columns>
    </RadzenDataGrid>
  </div>


    <div class="mt-3">
       <button type="button" @onclick="InsertWageInfo" class="btn btn-success">
           Submit
       </button>

        <button type="button" @onclick="DownloadPdf" class="btn btn-primary">
           Download PDF
       </button>


          
    </div>
    
}

@code {
    List<WorkerRecord> CurrentActiveWorkers { get; set; }
    private WageRecord _myWageInfo = new WageRecord();
    bool bIsLoading = false;
    private IEnumerable<SingleWageRecord> FilteredWageRecords =>
       string.IsNullOrWhiteSpace(FilterName) ? MyWageInfo.WageRecords :
       MyWageInfo.WageRecords.Where(w => w.Name.Contains(FilterName, StringComparison.OrdinalIgnoreCase));

    public WageRecord MyWageInfo
    {
        get => _myWageInfo;
        set
        {
            if (_myWageInfo != value)
            {
                _myWageInfo = value;

                BindEPFRecalculation();
                RecalculateEPFAsync(this, EventArgs.Empty);
            }
        }
    }
    string FilterName = "";
    [Inject]
    private HttpClient Http { get; set; }
    [Inject] 
    private IJSRuntime JS { get; set; }
    protected async override void OnInitialized()
    {
        await SearchWageInfo();


    }

    private async Task SearchWageInfo()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<WageRecord>(
                $"api/HR/GetWagesInfo?year={MyWageInfo.Year}&month={MyWageInfo.Month}");


            bIsLoading = true;
            if (result != null)
            {
                MyWageInfo = result;
            }
            else
            {

                await JS.InvokeVoidAsync("alert", "No data found.");
            }
        }
        catch (Exception ex)
        { 
            await GetNewActiveWorkers(EWorkerStatus.Active);
            await JS.InvokeVoidAsync("alert", "No data found for the selected year and month");
        }
        BindEPFRecalculation();
        bIsLoading = false;
        StateHasChanged();
    }

    private void BindEPFRecalculation()
    {
        foreach (var Record in MyWageInfo.WageRecords)
        {
            Record.EPFRecalculateHandler += RecalculateEPFAsync;
        }
    }

    private async void RecalculateEPFAsync(object o, EventArgs e)
    {
        if (bIsLoading)
        {
            return;
        }

        if (o is not SingleWageRecord targetRecord)
        {
            await JS.InvokeVoidAsync("alert", "Recalculate object not wage record");
            return;
        }
     

        foreach (SingleWageRecord record in MyWageInfo.WageRecords)
        {
            // Only process the matching record
            if (record.ID != targetRecord.ID)
                continue;

            try
            {
                var response = await Http.PostAsJsonAsync("api/HR/calculateEPF", record);

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ContributeResult>();

                    if (result != null)
                    {
                        record.EPF_Employer = result.EPFEmployerContribution;
                        record.EPF_Employee = result.EPFEmployeeContribution;
                        record.Socso_Employer = result.SocsoEmployerContribution;
                        record.Socso_Employee = result.SocsoEmployeeContribution;
                    }
                }
            }
            catch (Exception ex)
            {
                // Consider logging the exception
            }
        }

        StateHasChanged();
    }

    private async Task InsertWageInfo()
    {
        try
        {
            var response = await Http.PostAsJsonAsync(
                NavigationManager.ToAbsoluteUri("api/HR/InsertWagesInfo"),
                MyWageInfo);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "SubmitSuccess!");
            }
            else
            {
                // Read the error message from the response
                var errorMessage = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"SubmitFail! Reason: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            // Handle unexpected exceptions
            await JS.InvokeVoidAsync("alert", $"SubmitFail! Exception: {ex.Message}");
        }
    }
    private async Task GetNewActiveWorkers(EWorkerStatus status)
    {
        try
        {
            var url = $"api/HR/GetAllWorkers?status={status}";

            CurrentActiveWorkers = await Http.GetFromJsonAsync<List<WorkerRecord>>(url)
                ?? new List<WorkerRecord>();

            MyWageInfo.FormWageRecordFromWorkerRecords(CurrentActiveWorkers);

            await JS.InvokeVoidAsync("alert", $"SearchResult: {MyWageInfo.WageRecords.Count()}");
            BindEPFRecalculation();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error retrieving {status} workers: {ex}");
            CurrentActiveWorkers = new List<WorkerRecord>();
        }
    }
    private async Task DownloadPdf()
    {
        if (MyWageInfo.WageRecords.Count == 0)
        {

            await JS.InvokeVoidAsync("alert", "Table is empty");
        }
        GenerateWagesPdfRequest wagesPdfRequest = new GenerateWagesPdfRequest();
        wagesPdfRequest.Year = MyWageInfo.Year;
        wagesPdfRequest.Month = MyWageInfo.Month;
        var json = await JS.InvokeAsync<string>("getCookie", "userKey");
        if (!string.IsNullOrWhiteSpace(json))
        {
            try
            {
                UserName restoredUser = System.Text.Json.JsonSerializer.Deserialize<UserName>(json);
                wagesPdfRequest.MyUser = restoredUser;
            }
            catch(Exception ex)
            { 

            }
        }
      
        
        var response = await Http.PostAsJsonAsync("api/pdf/purchase", wagesPdfRequest);
        byte[] pdfBytes = await response.Content.ReadAsByteArrayAsync();
        //var pdfBytes = await Http.GetByteArrayAsync($"api/pdf/purchase?year={MyWageInfo.Year}&month={MyWageInfo.Month}");
        var base64 = Convert.ToBase64String(pdfBytes);
        await JS.InvokeVoidAsync("downloadFileFromBase64", $"Wages-{MyWageInfo.Year}-{MyWageInfo.Month}.pdf", base64);
    }

    private async Task SlipPdf (SingleWageRecord worker)
    {
        if (worker == null) return;

        try
        {
            var response = await Http.PostAsJsonAsync("api/pdf/slip", worker);

            if (!response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", $"Failed to generate PDF for {worker.Name}");
                return;
            }

            var pdfBytes = await response.Content.ReadAsByteArrayAsync();
            var base64 = Convert.ToBase64String(pdfBytes);

            await JS.InvokeVoidAsync("downloadFileFromBase64", $"PaymentSlip-{worker.Name}.pdf", base64);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error generating PDF for {worker.Name}: {ex.Message}");
        }
    }



    
}
