@page "/login"
@page "/authentication/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.Graph
@using PurchaseBlazorApp2.Components.Data
@using PurchaseBlazorApp2.Components.Global
@using Radzen
@using Radzen.Blazor
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS
@inject IServiceProvider ServiceProvider
@inject NavigationManager NavigationManager
@inject ClientGlobalVar GlobalVar
@inject AuthenticationStateProvider AuthStateProvider


<CascadingAuthenticationState>
    <CascadingValue Value="this">
        <!-- Main Container: Flexbox used to center the card vertically and horizontally -->
        <div class="d-flex justify-content-center align-items-center" style="min-height: 100vh; background-color: #f4f4f4;">
            
            @if (authState is null)
            {
                <!-- 1. LOADING STATE -->
                <div class="rz-text-align-center">
                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
                    <p class="rz-mt-2 text-muted">⏳ Loading authentication...</p>
                </div>
            }
            else if (!authState.User.Identity?.IsAuthenticated ?? true)
            {
                <!-- 2. LOGIN View -->
                <RadzenCard Class="rz-shadow-10 rz-p-8 rz-text-align-center" Style="width: 100%; max-width: 400px; background: white;">
                    
                    <!-- Your Logo -->
                    <RadzenImage Path="PineappleLogo.jpeg" Style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover;" AlternateText="Logo" />
                    
                    <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H1" Class="rz-mb-4">
                        Genesis Purchase App
                    </RadzenText>

                    @if (!startLogin)
                    {
                        <!-- Login Button -->
                        <RadzenButton Text="Login" 
                                      Icon="login" 
                                      ButtonStyle="ButtonStyle.Primary" 
                                      Size="ButtonSize.Large" 
                                      Click="@StartLogin" 
                                      Style="width: 100%;" />
                    }
                    else if (remoteAuthServiceAvailable)
                    {
                        <!-- Redirect Logic -->
                        <div class="rz-mt-4">
                            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <p class="rz-mt-2 rz-message">Connecting to Microsoft...</p>
                            
                            <!-- This component is invisible but handles the redirect -->
                            <RemoteAuthenticatorView Action="login" OnLogInSucceeded="HandleLogInSucceeded" />
                        </div>
                    }
                    else
                    {
                        <!-- Show Error State -->
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" Class="rz-mt-4">
                            Login service unavailable.
                        </RadzenAlert>
                    }
                </RadzenCard>
            }
            else
            {
                <!-- 3. ALREADY LOGGED IN STATE -->
                <RadzenCard Class="rz-shadow-10 rz-p-12 rz-text-align-center">
                    <RadzenIcon Icon="check_circle" IconColor="@Colors.Success" Style="font-size: 3rem; margin-bottom: 1rem;" />
                    <RadzenText TextStyle="TextStyle.H6">Welcome, @authState.User.Identity?.Name</RadzenText>
                    <RadzenButton Text="Continue" Click="@(() => NavigationManager.NavigateTo("/"))" ButtonStyle="ButtonStyle.Secondary" Class="rz-mt-4"/>
                </RadzenCard>
            }

        </div>
    </CascadingValue>
</CascadingAuthenticationState>

@code {
    private AuthenticationState? authState;
    private bool startLogin = false;
    private bool remoteAuthServiceAvailable = false;

    public class GraphUser
    {
        public string DisplayName { get; set; } = "";
        public string JobTitle { get; set; } = "";
        public string Department { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        startLogin = false;

        // Safe check for AuthStateProvider
        try
        {
            authState = await AuthStateProvider.GetAuthenticationStateAsync();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Failed to get auth state: {ex.Message}");
            authState = null;
        }

        // Check if RemoteAuthenticationService is registered
        remoteAuthServiceAvailable = ServiceProvider.GetService<IRemoteAuthenticationService<RemoteAuthenticationState>>() != null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                authState = await AuthStateProvider.GetAuthenticationStateAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Error fetching auth state: {ex.Message}");
            }
        }

        // Avoid rendering loop, force reload only if not in browser or no auth state
        if (!OperatingSystem.IsBrowser() || authState == null)
        {
            await Task.Delay(1000);
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
    }
   
    private void StartLogin()
    {
    startLogin = true;
    }
  


    private async Task HandleLogInSucceeded(RemoteAuthenticationState state)
    {
        await JS.InvokeVoidAsync("console.log", "HandleLogInSucceeded triggered");

        try
        {
            // --- AUTH STATE ---
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated != true)
            {
                await JS.InvokeVoidAsync("console.log", "User not authenticated.");
                return;
            }

            await JS.InvokeVoidAsync("console.log", "User authenticated.");

            // --- ACCESS TOKEN ---
            var tokenProvider = ServiceProvider.GetService<IAccessTokenProvider>();
            if (tokenProvider == null)
            {
                await JS.InvokeVoidAsync("console.log", "No token provider found.");
                return;
            }

            var tokenResult = await tokenProvider.RequestAccessToken();
            if (!tokenResult.TryGetToken(out var token))
            {
                await JS.InvokeVoidAsync("console.log", "Failed to acquire access token.");
                return;
            }

            await JS.InvokeVoidAsync("console.log", $"Access token acquired: {token.Value[..20]}...");

            // --- USER VALUES FROM CLAIMS ---
            string displayName = authState.User.Identity?.Name ?? "(Unknown User)";
            string email = authState.User.FindFirst(c =>
                c.Type == "preferred_username" || c.Type == "email")?.Value ?? "";

            // ---------- START PARALLEL CALLS ----------
            var graphTask = GetGraphUserAsync(token.Value);
            var existsTask = Http.GetFromJsonAsync<bool>($"api/login/checkexist/{email}");
            var roleTask = Http.PostAsJsonAsync(
                NavigationManager.ToAbsoluteUri("api/login/getrole"),
                email
            );

            await Task.WhenAll(graphTask, existsTask, roleTask);
            // ---------- END PARALLEL ----------

            // --- HANDLE BACKEND EXISTENCE CHECK ---
            if (!existsTask.Result)
            {
                NavigationManager.NavigateTo("mainlogout");
                await JS.InvokeVoidAsync("alert", "unauthorized!");
                return;
            }

            // --- ROLE ---
            EDepartment departmentRole = EDepartment.NotSpecified;
            try
            {
                var roleResponse = roleTask.Result;
                departmentRole = await roleResponse.Content.ReadFromJsonAsync<EDepartment>();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Error retrieving role: {ex.Message}");
            }

            // --- MICROSOFT GRAPH USER INFO ---
            var graph = graphTask.Result;
            string jobTitle = graph?.JobTitle ?? "(No Job Title)";
            string department = graph?.Department ?? "(No Department)";

            // --- BUILD USER ---
            var MyUser = new UserName(displayName, "")
            {
                Role = departmentRole,
                JobTitle = jobTitle,
                Department = department,
                Email = email
            };

            // --- STORE COOKIE ---
            if (JS != null)
            {
                await JS.InvokeVoidAsync("console.log", "Setting user cookie...");
                string jsonUser = System.Text.Json.JsonSerializer.Serialize(MyUser);
                await JS.InvokeVoidAsync("setCookie", "userKey", jsonUser, 1);
            }

            // --- STORE USER IN GLOBAL ---
            GlobalVar?.SetUser(MyUser);
            GlobalVar?.StartTokenRefreshLoop(tokenProvider);

            await JS.InvokeVoidAsync("console.log", $"Logged in as: {displayName}");

            // --- HANDLE RETURN URL ---
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var returnUrl = query["returnUrl"];

            if (!string.IsNullOrEmpty(returnUrl))
            {
                if (!returnUrl.StartsWith("/")) returnUrl = "/" + returnUrl;
                NavigationManager.NavigateTo(returnUrl, forceLoad: true);
            }
            else
            {
                NavigationManager.NavigateTo("/");
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error in HandleLogInSucceeded: {ex.Message}");
        }
    }


    private async Task<GraphUser?> GetGraphUserAsync(string token)
    {
        try
        {
            var request = new HttpRequestMessage(
                HttpMethod.Get,
                "https://graph.microsoft.com/v1.0/me?$select=displayName,jobTitle,department,mail,userPrincipalName"
            );

            request.Headers.Authorization =
                new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
                return await response.Content.ReadFromJsonAsync<GraphUser>();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Graph API error: {ex.Message}");
        }

        return null;
    }
}
