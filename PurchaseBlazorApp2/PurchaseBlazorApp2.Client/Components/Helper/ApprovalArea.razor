@using PurchaseBlazorApp2.Components.Data
@using PurchaseBlazorApp2.Components.Global

<label class="form-label">Approvals:</label>
@for (int i = 0; i < Approvals.Count; i++)
{
    var approval = Approvals[i];
    bool canApprove = approval.CanApprove(MyGlobalVar.UserName.Role);

    @* Console.WriteLine("Can Approve" + canApprove); *@

    <div class="approval-item d-flex flex-wrap align-items-center gap-3 mb-2 p-2 border rounded">
        <!-- Checkbox -->
        <InputCheckbox Value="approval.IsApproved"
        ValueChanged="@((bool val) => OnCheckboxChanged(val, approval))"
        ValueExpression="@(() => approval.IsApproved)"
        class="form-check-input"
        disabled="@(!canApprove)" />       

        <!-- Departments and details -->
        <div class="flex-grow-1 min-width-0">
            <div class="d-flex flex-wrap justify-content-between align-items-center">
                <div class="me-3 text-truncate">
                    <small class="text-muted">Departments:</small>
                    <div class="fw-semibold text-truncate">@string.Join(", ", approval.Departments)</div>
                </div>

                <div class="d-flex align-items-center">
                    <small class="text-muted me-1">Approved by:</small>
                    <span class="badge bg-light text-dark">@(!string.IsNullOrEmpty(approval.UserName) ? approval.UserName : "-")</span>
                </div>
            </div>
        </div>
        
    </div>
}

@code {
    [Parameter] public List<ApprovalInfo> Approvals{ get; set; } = new List<ApprovalInfo>();
    [Parameter] public ClientGlobalVar MyGlobalVar { get; set; }
    [Parameter] public EventCallback<(bool NewValue, ApprovalInfo Approval)> OnApprovalChanged { get; set; }
 
    private async Task OnCheckboxChanged(bool newValue, ApprovalInfo approval)
    {
        approval.IsApproved = newValue;

        if (newValue)
        {
            approval.UserName = MyGlobalVar?.UserName.Name ?? "";

        }

        else
        {
            approval.UserName = "";

        }
        await OnApprovalChanged.InvokeAsync((newValue, approval));
        
    }
}
