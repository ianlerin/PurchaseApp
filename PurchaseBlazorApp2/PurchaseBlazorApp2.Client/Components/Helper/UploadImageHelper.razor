@using Radzen
@using Radzen.Blazor
@using PurchaseBlazorApp2.Components.Data
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS

@if (bNewRequisition)
{
    <!-- Editable Upload -->
    <RadzenUpload ChooseText="Upload Files"
                  Multiple="true"
                  Accept="image/*,application/pdf"
                  Change="OnUploadChange"
                  Style="margin-bottom: 10px;" />
}

@if (UploadedImages.Count > 0)
{
    <!-- Flex container for images -->
    <div class="@GetContainerClass()"
         style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; align-items: flex-start;">

        @foreach (var image in UploadedImages)
        {
            var index = UploadedImages.FindIndex(x => x.Id == image.Id);
            var isSelected = SelectionType switch
            {
                ESelectionType.SingleSelect => SelectedIndex == index,
                ESelectionType.MultiSelect => SelectedIndices.Contains(index),
                _ => false
            };

            <div class="border p-2 position-relative"
                 style="flex: 1 1 300px; max-width:@ImageWidthPx; background-color:@(isSelected ? "#e6f2ff" : "transparent");">

                @if (image.DataFormat.StartsWith("image/"))
                {
                    <!-- Show as Image -->
                    <img src="@GetImageSrc(image)"
                         class="img-thumbnail"
                         style="width: 100%; height: auto; max-height:@ImageHeightPx; cursor:pointer;"
                         @onclick="@(() => ShowZoom(image))" />
                }
                else if (image.DataFormat == "application/pdf")
                {
                    <!-- Show as PDF Preview -->
                    <div style="position: relative; width: 100%; height:@ImageHeightPx;">
                        <iframe src="@GetImageSrc(image)"
                                style="width: 100%; height:100%; border:none;"
                                title="PDF Preview">
                        </iframe>
                        <div style="position: absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;"
                             @onclick="@(() => ShowZoom(image))">
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center">Unsupported file type</p>
                }

                @if (SelectionType != ESelectionType.None)
                {
                    <button class="btn btn-sm @(isSelected ? "btn-success" : "btn-primary") w-100 mt-1"
                            @onclick="@(() => SelectImage(image.Id))" disabled="@(!bNewRequisition)">
                        
                        @(isSelected ? "Selected" : "Select")
                    </button>
                }

                @if (bNewRequisition)
                {
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0"
                            @onclick="@(() => RemoveImage(image.Id))">
                        ✕
                    </button>
                }
            </div>
        }
    </div>
}
else
{
    <p>No images uploaded yet.</p>
}


<ImagePage ImageSrc="@ZoomedImageSrc" Visible="@IsZoomVisible" OnClose="@HideZoom" />

@code {
    public enum ESelectionType
    {
        None,
        SingleSelect,
        MultiSelect
    }

    public enum EOrientation
    {
        Horizontal,
        Vertical
    }

    [Parameter] public EventCallback<int> OnImageSelected { get; set; }
    [Parameter] public List<ImageUploadInfo> UploadedImages { get; set; } = new();
    [Parameter] public ESelectionType SelectionType { get; set; } = ESelectionType.None;

    [Parameter] public int? SelectedIndex { get; set; }
    [Parameter] public EventCallback<int?> SelectedIndexChanged { get; set; }

    public HashSet<int> SelectedIndices { get; set; } = new();

    [Parameter] public EOrientation Orientation { get; set; } = EOrientation.Horizontal;
    [Parameter] public bool bNewRequisition { get; set; } = false;
    [Parameter] public int ImageWidth { get; set; } = 150;
    [Parameter] public int ImageHeight { get; set; } = 150;

    private ImageUploadInfo? ZoomedUploadInfo;
    private string? ZoomedImageSrc;
    private bool IsZoomVisible;

    private string ImageWidthPx => $"{ImageWidth}px";
    private string ImageHeightPx => $"{ImageHeight}px";

    private string GetContainerClass()
    {
        return Orientation == EOrientation.Horizontal
            ? "d-flex flex-wrap gap-3"
            : "d-flex flex-column gap-3";
    }
    private async Task OnUploadChange(UploadChangeEventArgs args)
    {
        foreach (var file in args.Files)
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();

            var newImage = new ImageUploadInfo
                {
                    Id = Guid.NewGuid(),
                    Data = buffer,
                    DataFormat = file.ContentType
                };

            UploadedImages.Add(newImage);

            // Auto-select first uploaded image if selection mode is enabled
            var newIndex = UploadedImages.Count - 1;
            if (SelectionType == ESelectionType.SingleSelect && SelectedIndex == null)
            {
                SelectedIndex = newIndex;
                await SelectedIndexChanged.InvokeAsync(SelectedIndex);
            }
            else if (SelectionType == ESelectionType.MultiSelect && SelectedIndices.Count == 0)
            {
                SelectedIndices.Add(newIndex);
            }
        }

        StateHasChanged();
    }

    private void RemoveImage(Guid id)
    {
        var index = UploadedImages.FindIndex(img => img.Id == id);
        if (index == -1) return;

        if (SelectionType == ESelectionType.SingleSelect)
        {
            if (SelectedIndex == index)
                SelectedIndex = null;
            else if (SelectedIndex > index)
                SelectedIndex--;
        }
        else if (SelectionType == ESelectionType.MultiSelect)
        {
            SelectedIndices.Remove(index);
            SelectedIndices = SelectedIndices.Select(i => i > index ? i - 1 : i).ToHashSet();
        }

        UploadedImages.RemoveAt(index);
        SelectedIndexChanged.InvokeAsync(SelectedIndex);
    }

    private async void ShowZoom(ImageUploadInfo image)
    {
        ZoomedUploadInfo=image;
        ZoomedImageSrc = GetImageSrc(image);
        await JS.InvokeVoidAsync("console.log", $"zoom {ZoomedImageSrc}");
        IsZoomVisible = true;
    }

    private void HideZoom()
    {
        ZoomedImageSrc = null;
        IsZoomVisible = false;
    }

    private async void SelectImage(Guid id)
    {
        var index = UploadedImages.FindIndex(img => img.Id == id);
        if (index == -1) return;

        switch (SelectionType)
        {
            case ESelectionType.SingleSelect:
                SelectedIndex = index;
                await SelectedIndexChanged.InvokeAsync(SelectedIndex);
                break;

            case ESelectionType.MultiSelect:
                if (SelectedIndices.Contains(index))
                    SelectedIndices.Remove(index);
                else
                    SelectedIndices.Add(index);
                break;
        }

        if (SelectionType == ESelectionType.SingleSelect && SelectedIndex.HasValue)
            await OnImageSelected.InvokeAsync(SelectedIndex.Value);

        StateHasChanged();
    }

    private string GetImageSrc(ImageUploadInfo uploadInfo)
    {
        var base64 = Convert.ToBase64String(uploadInfo.Data);
        return $"data:{uploadInfo.DataFormat};base64,{base64}";
    }

    private async void OpenPdf(ImageUploadInfo image)
    {
        var src = GetImageSrc(image);
        await JS.InvokeVoidAsync("open", src, "_blank"); // Opens PDF in new tab
    }
}
